<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');class Dine extends CI_Controller {	public $arrMenu = array();	public $data;	public $privilege = array();	public function __construct()	{		parent::__construct();                if( ! $_SESSION)                {                    session_start();                }		if(empty($_SESSION['admin_data'])){			session_destroy();			redirect(BASE_URL_BACKEND."/signin");			exit();		}		$this->load->model(array('backend/Model_menu_frontend','backend/Model_dine','backend/Model_dine_menu','backend/Model_alias', 'backend/Model_language','backend/Model_logcms'));		$this->load->helper(array('funcglobal','menu','accessprivilege','alias'));		                $module_name=  $this->uri->segment(2);                $getmodule = $this->Model_dine->getModule($module_name);                foreach ($getmodule as $gm) {                 $this->module_id = $gm->module_id;                 $this->section = $gm->module_group_id;                 $_SESSION['module_id']=$this->module_id;                }		//get menu from helper menu		//get menu from helper menu		$this->arrMenu = menu();		$this->data = array();                $this->data['ListMenu'] = $this->arrMenu;                $this->data['CountMenu'] = count($this->arrMenu);		$this->data['controller'] = $module_name;               		//check privilege module		$this->privilege = accessprivilegeuserlevel($_SESSION['admin_data']['user_level_id'], $_SESSION['module_id']);		$this->breadcrump = breadCrump($_SESSION['module_id']);	}	public function index()	{		$this->view();	}		function view(){		$admin_data = $_SESSION['admin_data'];		$this->data['admin_data'] = $admin_data;		$this->data['section'] = $this->section; 		$this->data['modul_id'] = $_SESSION['module_id'];		$this->data['breadcrump'] = $this->breadcrump;		$searchkey = "";		$searchby = "";                             $condp = "order BY a.dine_order";                $ListDine = $this->Model_dine->getListDine($condp);			$this->data["ListDine"] = $ListDine;		//extract privilege		$this->data["list"] = $this->privilege[0];		$this->data["view"] = $this->privilege[1];		$this->data["add"] = $this->privilege[2];		$this->data["edit"] = $this->privilege[3];		$this->data["publish"] = $this->privilege[4];		$this->data["approve"] = $this->privilege[5];		$this->data["delete"] = $this->privilege[6];		$this->data["order"] = $this->privilege[7];		if($this->data["list"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}				$this->data['searchkey'] = $searchkey;		$this->data['searchby'] = $searchby;				$this->load->view('backend/header',$this->data);		$this->load->view('backend/Dine/list');	}         function add(){		//extract privilege		$this->data["add"] = $this->privilege[2];		if($this->data["add"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}		                              		$admin_data = $_SESSION['admin_data'];		$this->data['admin_data'] = $admin_data;		$this->data['section'] = $this->section; 		$this->data['modul_id'] = $this->module_id;		$this->data['breadcrump'] = $this->breadcrump;               		$this->load->view('backend/header',$this->data);		$this->load->view('backend/Dine/add',$this->data);	}      	public function doAdd(){		//extract privilege		$this->data["add"] = $this->privilege[2];		if($this->data["add"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}		$tb = $_POST['tbSave'];		if (!$tb) {			redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);			exit();		}		$admin_data = $_SESSION['admin_data'];		$this->data['admin_data'] = $admin_data;		$this->data['section'] = $this->section; 		$this->data['modul_id'] = $this->module_id;		$this->data['breadcrump'] = $this->breadcrump;		$dine_title = $this->security->xss_clean(secure_input($_POST['dinetitle']));                $dine_name = $this->security->xss_clean(secure_input($_POST['dinename']));                 $dine_time = $this->security->xss_clean(secure_input($_POST['dinetime']));                 $dine_imageurl = $this->security->xss_clean(secure_input($_POST['dineimageurl']));		$dine_desc = $this->security->xss_clean(secure_input($_POST['dinedesc']));                $dine_urla = $this->security->xss_clean(secure_input($_POST['dineurla']));                 $dine_urlb = $this->security->xss_clean(secure_input($_POST['dineurlb']));                		$pesan = array();		// Validasi data		if ($dine_title=="") {			$pesan[] = 'Dine Page Title is empty';		} 			if (! count($pesan)==0 ) {			foreach ($pesan as $indeks=>$pesan_tampil) {				$this->data['error'] = $pesan_tampil;								$this->data['dinetitle']=$dine_title;                                $this->data['dinename']=$dine_name;                                $this->data['dinedesc']=$dine_desc;                                $this->data['dinetime']=$dine_time;                                $this->data['dineimageurl']=$dine_imageurl;                                $this->data['dineurla']=$dine_urla;                                $this->data['dineurlb']=$dine_urlb;                               													$this->load->view('backend/header',$this->data);				$this->load->view('backend/Dine/add',$this->data);			}		} else {			$cekDine = $this->Model_dine->checkDine($dine_title);			$countDine = count($cekDine);						if ($countDine > 0 ) {				$this->data['error']='Dine Title '.$dine_title.' already exist';				$this->data['dine_title']=$dine_title;							$this->load->view('backend/header',$this->data);				$this->load->view('backend/Dine/add',$this->data);			} else {				$dine_imageurl = str_replace(BASE_URL,"",$dine_imageurl);				$dine_id = $this->Model_dine->insertDine($dine_title,$dine_name,$dine_time, $dine_imageurl,$dine_desc,$dine_urla,$dine_urlb);                                $today= date("Y-m-d H:i:s");                                $data = array();                                  for ($i = 0; $i < count($this->input->post('subpage_title')); $i++) {                                      $checkfile = $this->Model_dine_menu->checkMenu($this->security->xss_clean(secure_input($_POST['dine_menu_title'][$i])), $dine_id);                                      if (empty($checkfile)){                                         $data[] = array(                                          'dine_id'=>$dine_id,                                          'dine_menu_title' => $this->security->xss_clean(secure_input($_POST['subpage_title'][$i])),                                          'dine_menu_desc' => $this->security->xss_clean(secure_input($_POST['subpage_desc'][$i])),                                          'dine_menu_order'=>1,                                          'dine_menu_active_status'=>1,                                          'dine_menu_create_date'=>$today,                                          'dine_menu_create_by'=>$_SESSION['admin_data']['user_id'],                                          'dine_menu_update_date'=>'',                                          'dine_menu_update_by'=>''                                           );                                                                                   }                                  }                                                                        $this->Model_dine_menu->insertMenu($data);					$log_module = "Add ".$this->module;					$log_value = $dine_id." | ".$dine_title;					$insertlog = $this->Model_logcms->insertLogCMS($log_module,$log_value);									redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);				}			}		}   	function active($id){		if (empty($id)) {			redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);			exit();		}		//extract privilege		$this->data["approve"] = $this->privilege[5];		if($this->data["approve"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}		$rsDine = $this->Model_dine->getDine($id); 		$title = $rsDine[0]['dine_title'];		$active_status = abs($rsDine[0]['dine_active_status']-1);		$active = $this->Model_dine->activeDine($id);		createRouteAlias(); //create route alias		if($active_status == 1){			$log_module = "Active ".$this->data['controller'];		} else {			$log_module = "Inactive ".$this->data['controller'];		}		$log_value = $id." | ".$title." | ".$active_status;		$insertlog = $this->Model_logcms->insertLogCMS($log_module,$log_value);                                $this->generateDine();		redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);	}         function delete($id){		if (empty($id)) {			redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);			exit();		}		//extract privilege		$this->data["delete"] = $this->privilege[6];				if($this->data["delete"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}		$rsDine = $this->Model_dine->getDine($id); 		$title = $rsDine[0]['dine_title'];                                      if($page_type == 2){                $this->deleteDine($id);                }                $delete = $this->Model_dine->deleteDine($id);		$log_module = "Delete ".$this->module;		$log_value = $id." | ".$title;		$insertlog = $this->Model_logcms->insertLogCMS($log_module,$log_value);                                $this->generateDine();		redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);	}              public function deleteDine($id){            if (empty($id)) {			redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);			exit();		}		//extract privilege		$this->data["delete"] = $this->privilege[6];		if($this->data["delete"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}                $where = "";                $orderBy = "ORDER BY a.dine_id DESC";				$cond 			= $where." ".$orderBy;                $ListDine = $this->Model_dine->getListDine($id, $cond);                foreach($ListDine as $dine){                          $image_path = './assets/images/'.$dine['dine_image'];                         $image_resize = './assets/images/resized/'.$dine['dine_image'];                                 $image_thumb = './assets/images/thumb/'.$dine['dine_image'];                         if($dine['dine_image'] != 'default_icon.png'){                        unlink($image_path);                        unlink($image_resize);                        unlink($image_thumb);                           }                             $this->Model_dine->deleteDine($dine['dine_id']);                }                               $this->generateDine();        }      public function edit($id){		if (empty($id)) {			redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);			exit();		}		//extract privilege		$this->data["edit"] = $this->privilege[3];		if($this->data["edit"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}		$admin_data = $_SESSION['admin_data'];		$this->data['admin_data'] = $admin_data;		$this->data['section'] = $this->section; 		$this->data['modul_id'] = $this->module_id;		$this->data['breadcrump'] = $this->breadcrump;			$rsDine = $this->Model_dine->getDine($id);                 // mengambil database dari model untuk dikirim ke view		                $countDine = count($rsDine);		$this->data['rsDine'] = $rsDine;		$this->data['countDine'] = $countDine;		$this->load->view('backend/header',$this->data);		$this->load->view('backend/Dine/edit',$this->data);	}		public function doEdit($id){		$tb = $_POST['tbEdit'];		if (!$tb OR $id == '') {			redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);			exit();		}		//extract privilege		$this->data["edit"] = $this->privilege[3];		if($this->data["edit"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}		$admin_data = $_SESSION['admin_data'];		$this->data['admin_data'] = $admin_data;		$this->data['section'] = $this->section; 		$this->data['modul_id'] = $this->module_id;		$this->data['breadcrump'] = $this->breadcrump;		$rsDine = $this->Model_dine->getDine($id);  // mengambil database dari model untuk dikirim ke view		$countDine = count($rsDine);		$this->data['rsDine'] = $rsDine;		$this->data['countDine'] = $countDine;		$dine_title = $this->security->xss_clean(secure_input($_POST['dinetitle']));                $dine_titleOld = $this->security->xss_clean(secure_input($_POST['dine_titleOld']));                $dine_name = $this->security->xss_clean(secure_input($_POST['dinename']));                 $dine_time = $this->security->xss_clean(secure_input($_POST['dinetime']));                 $dine_imageurl = $this->security->xss_clean(secure_input($_POST['dineimageurl']));		$dine_desc = $this->security->xss_clean(secure_input($_POST['dinedesc']));                $dine_urla = $this->security->xss_clean(secure_input($_POST['dineurla']));                 $dine_urlb = $this->security->xss_clean(secure_input($_POST['dineurlb'])); 				$pesan = array();		// Validasi data		if ($dine_title=="") {			$pesan[] = 'Dine Title is empty';		} 		if (! count($pesan)==0 ) {			foreach ($pesan as $indeks=>$pesan_tampil) {				$this->data['error'] = $pesan_tampil;				$this->load->view('backend/header',$this->data);				$this->load->view('backend/Dine/edit',$this->data);			}		} else {			$dine_imageurl = str_replace(BASE_URL,"",$dine_imageurl);				$update = $this->Model_dine->updateDine($id,$dine_title,$dine_name,$dine_time,$dine_imageurl,$dine_desc,$dine_urla,$dine_urlb);				                                $log_module = "Edit ".$this->module;                                $log_value = $id." | ".$dine_title;                                $insertlog = $this->Model_logcms->insertLogCMS($log_module,$log_value);                                                                $this->generateDine();                                         redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);			}			}                 function doOrder(){		$order = $this->security->xss_clean($_POST['order']);		if($order == ""){			redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);			exit();		}         foreach($order as $id => $ordervalue){			$this->Model_dine->updateOrderDine($id,$ordervalue);                        echo $ordervalue;		}                $this->generateDine();		redirect(BASE_URL_BACKEND.'/'.$this->data['controller']);	}               function listMenuDine($dine_id=NULL){                                $_SESSION['dine_id'] = $dine_id;                $admin_data = $_SESSION['admin_data'];		$this->data['admin_data'] = $admin_data;		$this->data['section'] = $this->section; 		$this->data['modul_id'] = $this->module_id;		$this->data['breadcrump'] = $this->breadcrump;				$cond = "ORDER BY a.dine_menu_id ASC";		$listMenuDine = $this->Model_dine_menu->getMenu($dine_id, $cond);////		print_r($ListDine);//                die;		$this->data["listMenuDine"] = $listMenuDine;		//extract privilege		$this->data["list"] = $this->privilege[0];		$this->data["view"] = $this->privilege[1];		$this->data["add"] = $this->privilege[2];		$this->data["edit"] = $this->privilege[3];		$this->data["publish"] = $this->privilege[4];		$this->data["approve"] = $this->privilege[5];		$this->data["delete"] = $this->privilege[6];		$this->data["order"] = $this->privilege[7];		if($this->data["list"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}		$this->load->view('backend/header',$this->data);		$this->load->view('backend/dine_menu/list');	}              function insertMenu() {          $dine_id = $_SESSION['dine_id'];        $today= date("Y-m-d H:i:s");            $data = array();              for ($i = 0; $i < count($this->input->post('subpage_title')); $i++) {                 $data[] = array(                      'dine_id'=>$dine_id,                      'dine_menu_title' => $this->security->xss_clean(secure_input($_POST['subpage_title'][$i])),                      'dine_menu_desc' =>  $this->security->xss_clean(secure_input($_POST['subpage_desc'][$i])),                      'dine_menu_active_status'=>0,                      'dine_menu_order'=>($i+1),                      'dine_menu_create_date'=>$today,                      'dine_menu_create_by'=>$_SESSION['admin_data']['user_id'],                      'dine_menu_update_date'=>'',                      'dine_menu_update_by'=>''                  );              }         $this->Model_dine_menu->insertMenu($data);         $this->data['errors'] = $this->error;         $this->data['success'] = $this->success;        $this->generateDine();        redirect(BASE_URL_BACKEND.'/'.$this->data['controller'].'/listMenuDine/'.$dine_id);    }            function editMenu(){            $dine_menu_id = $this->input->post('primary_key');            $dine_menu_title = $this->input->post('title');             $dine_menu_desc = $this->input->post('menudesc');             $dine_menu_status=$this->input->post('status');             $dine_menu_order = $this->input->post('order');            if ($_SESSION['admin_data']['user_level_id'] == 1){                    $dine_menu_status = $dine_menu_status;                } else {                     $dine_menu_status = 0;                }            $this->Model_dine_menu->editMenu($dine_menu_title,$dine_menu_desc,$dine_menu_order,$dine_menu_status,$dine_menu_id);            $this->generateDine();                       redirect(BASE_URL_BACKEND.'/'.$this->data['controller'].'/listMenuDine/'.$_SESSION['dine_id']);    }           function activeMenu($id){		if (empty($id)) {			redirect(BASE_URL_BACKEND.'/'.$this->data['controller'].'/listMenuDine/'.$_SESSION['dine_id']);			exit();		}			//extract privilege		$this->data["approve"] = $this->privilege[5];				if($this->data["approve"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}		$rsContent = $this->Model_dine_menu->getMenuBy($id); 		$title = $rsContent[0]['dine_menu_title'];		$active_status = abs($rsContent[0]['dine_menu_active_status']-1);		$active = $this->Model_dine_menu->activeMenu($id);		//createRouteAlias(); //create route alias		if($active_status == 1){			$log_module = "Active ".$this->module;		} else {			$log_module = "Inactive ".$this->module;		}		$log_value = $id." | ".$title." | ".$active_status;		$insertlog = $this->Model_logcms->insertLogCMS($log_module,$log_value);		$this->generateDine();                redirect(BASE_URL_BACKEND.'/'.$this->data['controller'].'/listMenuDine/'.$_SESSION['dine_id']);			}         function deleteMenuBy($id){		if (empty($id)) {			redirect(BASE_URL_BACKEND.'/'.$this->data['controller'].'/listMenuDine/'.$_SESSION['dine_id']);			exit();		}		//extract privilege		$this->data["delete"] = $this->privilege[6];		if($this->data["delete"] == 0){			echo "<script>alert('Can\'t Access Module');window.location.href='".BASE_URL_BACKEND."/home';</script>";			die;		}       		$delete = $this->Model_dine_menu->deleteMenuby($id);		$log_module = "Delete ".$this->module;		$log_value = $id." | ".$title;		$insertlog = $this->Model_logcms->insertLogCMS($log_module,$log_value);                $this->generateDine();		redirect(BASE_URL_BACKEND.'/'.$this->data['controller'].'/listMenuDine/'.$_SESSION['dine_id']);	}       function generateDine(){                $ListDine		= $this->Model_dine->generateDine(" where a.dine_active_status=1 order by dine_order ASC");		$countDine		= count($ListDine);		//createCacheBanner($rsBanner,"bannerhome");               createCache($ListDine,"dine");        }       public function resizing($resize) {        $imageurl = str_replace(BASE_URL,PATH_PROJECT,$resize);        $image_name = end((explode('/', $resize)));       // echo PATH_PROJECT.$image_name;                $config['image_library'] = 'gd2';        $config['source_image'] = $imageurl;        $config['new_image'] = PATH_ASSETS.'/file_upload/thumbs/'.$image_name;                $config['create_thumb'] = FALSE;        $config['maintain_ratio'] = FALSE;        $config['width']         = 350;        $config['height']       = 300;        $config['x_axis']         = 150;        $config['y_axis']       = 150;        $this->load->library('image_lib', $config);        $this->image_lib->resize();        //$this->image_lib->crop();           }    }